# =========================
# logstash.conf
# =========================

input {
  # Recibe logs desde Filebeat
  beats {
    port => 5044
  }

  # Recibe logs TCP (si los envía algún cliente)
  tcp {
    port => 5000
    codec => plain
  }

  # Recibe logs UDP (opcional, si se envían por UDP)
  udp {
    port => 5000
    codec => plain
  }
}

filter {
  # Ejemplo de grok básico para syslog, opcional
  grok {
    match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_host} %{DATA:syslog_program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:syslog_message}" }
    tag_on_failure => ["grok_failed"]
  }

  # Añadir campo de tipo fijo para el índice
  mutate {
    add_field => { "[@metadata][index_name]" => "syslog-%{+YYYY.MM.dd}" }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]

    # Usar un índice válido
    index => "%{[@metadata][index_name]}"

    # Configuraciones recomendadas para ES 8
    ecs_compatibility => v8
    manage_template => true
    template_name => "logstash-syslog"
    template_overwrite => true
  }

  # Opcional: salida a consola para debug
  stdout {
    codec => rubydebug
  }
}
